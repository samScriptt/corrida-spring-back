<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema Completo - Corrida Rua</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body { padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        nav ul li { cursor: pointer; }
        .id-badge { background-color: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>
    <main class="container">
        <h1>üèÅ Sistema de Gest√£o de Corridas</h1>
        
        <nav>
            <ul>
                <li><strong onclick="mudarAba('equipes')">Equipes</strong></li>
                <li><strong onclick="mudarAba('pistas')">Pistas</strong></li>
                <li><strong onclick="mudarAba('carros')">Carros</strong></li>
                <li><strong onclick="mudarAba('pilotos')">Pilotos</strong></li>
                <li><strong onclick="mudarAba('corridas')">Corridas</strong></li>
                <li><strong onclick="mudarAba('inscricoes')">Inscri√ß√µes</strong></li>
            </ul>
        </nav>
        <hr>

        <section id="equipes" class="tab-content active">
            <h3>üè¢ Gest√£o de Equipes</h3>
            <form onsubmit="salvarGenerico(event, 'equipes', montadorEquipe)">
                <div class="grid">
                    <input type="text" name="nome" placeholder="Nome da Equipe" required>
                    <input type="text" name="cidade" placeholder="Cidade" required>
                    <input type="text" name="patrocinador" placeholder="Patrocinador" required>
                    <button type="submit">Salvar</button>
                </div>
            </form>
            <table role="grid"><thead><tr><th>ID</th><th>Nome</th><th>Cidade</th><th>A√ß√µes</th></tr></thead><tbody id="lista-equipes"></tbody></table>
        </section>

        <section id="pistas" class="tab-content">
            <h3>üõ£Ô∏è Gest√£o de Pistas</h3>
            <form onsubmit="salvarGenerico(event, 'pistas', montadorPista)">
                <div class="grid">
                    <input type="text" name="nome" placeholder="Nome da Pista" required>
                    <input type="text" name="cidade" placeholder="Cidade" required>
                    <input type="number" step="0.001" name="extensaoKm" placeholder="Extens√£o (km)" required>
                    <button type="submit">Salvar</button>
                </div>
            </form>
            <table role="grid"><thead><tr><th>ID</th><th>Nome</th><th>Cidade</th><th>Extens√£o</th><th>A√ß√µes</th></tr></thead><tbody id="lista-pistas"></tbody></table>
        </section>

        <section id="carros" class="tab-content">
            <h3>üèéÔ∏è Gest√£o de Carros</h3>
            <form onsubmit="salvarGenerico(event, 'carros', montadorCarro)">
                <div class="grid">
                    <input type="text" name="modelo" placeholder="Modelo" required>
                    <input type="text" name="placa" placeholder="Placa" required>
                    <input type="number" name="ano" placeholder="Ano" required>
                    <input type="text" name="cor" placeholder="Cor" required>
                    <input type="number" name="equipeId" placeholder="ID da Equipe" required title="Olhe na aba Equipes">
                    <button type="submit">Salvar</button>
                </div>
            </form>
            <table role="grid"><thead><tr><th>ID</th><th>Modelo</th><th>Placa</th><th>Equipe</th><th>A√ß√µes</th></tr></thead><tbody id="lista-carros"></tbody></table>
        </section>

        <section id="pilotos" class="tab-content">
            <h3>üë§ Gest√£o de Pilotos</h3>
            <form onsubmit="salvarGenerico(event, 'pilotos', montadorPiloto)">
                <div class="grid">
                    <input type="text" name="nome" placeholder="Nome Completo" required>
                    <input type="date" name="dataNascimento" required>
                    <input type="text" name="documento" placeholder="CPF/Doc" required>
                    <select name="categoria">
                        <option value="A">Categoria A</option>
                        <option value="B">Categoria B</option>
                        <option value="PRO-AM">PRO-AM</option>
                    </select>
                    <input type="number" name="equipeId" placeholder="ID da Equipe" required>
                    <button type="submit">Salvar</button>
                </div>
            </form>
            <table role="grid"><thead><tr><th>ID</th><th>Nome</th><th>Categoria</th><th>Equipe</th><th>A√ß√µes</th></tr></thead><tbody id="lista-pilotos"></tbody></table>
        </section>

        <section id="corridas" class="tab-content">
            <h3>üèÜ Gest√£o de Corridas</h3>
            <form onsubmit="salvarGenerico(event, 'corridas', montadorCorrida)">
                <div class="grid">
                    <input type="text" name="nome" placeholder="Nome do Evento" required>
                    <input type="date" name="data" required>
                    <select name="status"><option value="PLANEJADA">Planejada</option><option value="EM_ANDAMENTO">Em Andamento</option><option value="ENCERRADA">Encerrada</option></select>
                    <select name="categoria"><option value="STREET">Street</option><option value="DRAG">Drag</option><option value="DRIFT">Drift</option></select>
                    <input type="number" name="pistaId" placeholder="ID da Pista" required>
                    <button type="submit">Salvar</button>
                </div>
            </form>
            <table role="grid"><thead><tr><th>ID</th><th>Evento</th><th>Data</th><th>Status</th><th>Pista</th><th>A√ß√µes</th></tr></thead><tbody id="lista-corridas"></tbody></table>
        </section>

        <section id="inscricoes" class="tab-content">
            <h3>üìù Inscri√ß√µes</h3>
            <form onsubmit="salvarGenerico(event, 'inscricaos', montadorInscricao)">
                <div class="grid">
                    <input type="number" name="numeroLargada" placeholder="N¬∫ Largada" required>
                    <select name="situacao"><option value="PENDENTE">Pendente</option><option value="APROVADA">Aprovada</option><option value="INDEFERIDA">Indeferida</option></select>
                    <input type="number" name="corridaId" placeholder="ID Corrida" required>
                    <input type="number" name="pilotoId" placeholder="ID Piloto" required>
                    <input type="number" name="carroId" placeholder="ID Carro" required>
                    <button type="submit">Inscrever</button>
                </div>
            </form>
            <table role="grid"><thead><tr><th>ID</th><th>#</th><th>Corrida</th><th>Piloto</th><th>Carro</th><th>Situa√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="lista-inscricoes"></tbody></table>
        </section>

    </main>

    <script>
        const API = 'http://localhost:8080/api';

        // --- L√ìGICA DE ABAS ---
        function mudarAba(abaId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(abaId).classList.add('active');
            carregarDados(abaId); // Recarrega os dados ao entrar na aba
        }

        // --- MONTADORES DE JSON (Converte Form -> JSON do Backend) ---
        const montadorEquipe = (fd) => ({ nome: fd.get('nome'), cidade: fd.get('cidade'), patrocinador: fd.get('patrocinador') });
        const montadorPista = (fd) => ({ nome: fd.get('nome'), cidade: fd.get('cidade'), extensaoKm: fd.get('extensaoKm') });
        const montadorCarro = (fd) => ({ 
            modelo: fd.get('modelo'), placa: fd.get('placa'), ano: fd.get('ano'), cor: fd.get('cor'), 
            equipe: { id: fd.get('equipeId') } // Objeto aninhado
        });
        const montadorPiloto = (fd) => ({
            nome: fd.get('nome'), dataNascimento: fd.get('dataNascimento'), documento: fd.get('documento'), categoria: fd.get('categoria'),
            equipe: { id: fd.get('equipeId') }
        });
        const montadorCorrida = (fd) => ({
            nome: fd.get('nome'), data: fd.get('data'), status: fd.get('status'), categoria: fd.get('categoria'),
            pista: { id: fd.get('pistaId') }
        });
        const montadorInscricao = (fd) => ({
            numeroLargada: fd.get('numeroLargada'), situacao: fd.get('situacao'),
            corrida: { id: fd.get('corridaId') }, piloto: { id: fd.get('pilotoId') }, carro: { id: fd.get('carroId') }
        });

        // --- FUN√á√ïES GEN√âRICAS API ---
        async function salvarGenerico(event, endpoint, montador) {
            event.preventDefault();
            const form = event.target;
            const data = montador(new FormData(form));

            try {
                await fetch(`${API}/${endpoint}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
                });
                form.reset();
                carregarDados(endpoint === 'inscricaos' ? 'inscricoes' : endpoint); // Hack para ajuste de plural
            } catch (e) { alert('Erro ao salvar. Verifique os IDs.'); }
        }

        async function deletar(endpoint, id) {
            if(confirm('Excluir?')) {
                await fetch(`${API}/${endpoint}/${id}`, { method: 'DELETE' });
                // Ajuste de plural manual
                let aba = endpoint;
                if(endpoint === 'inscricaos') aba = 'inscricoes';
                carregarDados(aba);
            }
        }

        // --- RENDERIZADORES ---
        async function carregarDados(aba) {
            // Mapeia nome da aba -> endpoint da API
            let endpoint = aba;
            if(aba === 'inscricoes') endpoint = 'inscricaos';
            
            const res = await fetch(`${API}/${endpoint}`);
            const lista = await res.json();
            const tbody = document.getElementById(`lista-${aba}`);
            tbody.innerHTML = '';

            lista.forEach(item => {
                let html = '';
                // Renderiza√ß√£o espec√≠fica para cada tipo
                if(aba === 'equipes') {
                    html = `<td>${item.nome}</td><td>${item.cidade}</td>`;
                } else if(aba === 'pistas') {
                    html = `<td>${item.nome}</td><td>${item.cidade}</td><td>${item.extensaoKm}km</td>`;
                } else if(aba === 'carros') {
                    html = `<td>${item.modelo}</td><td>${item.placa}</td><td>${item.equipe?.nome || '-'}</td>`;
                } else if(aba === 'pilotos') {
                    html = `<td>${item.nome}</td><td>${item.categoria}</td><td>${item.equipe?.nome || '-'}</td>`;
                } else if(aba === 'corridas') {
                    html = `<td>${item.nome}</td><td>${item.data}</td><td>${item.status}</td><td>${item.pista?.nome || '-'}</td>`;
                } else if(aba === 'inscricoes') { // Corre√ß√£o do ID da aba
                    html = `<td>#${item.numeroLargada}</td><td>${item.corrida?.nome || '-'}</td><td>${item.piloto?.nome || '-'}</td><td>${item.carro?.modelo || '-'}</td><td>${item.situacao}</td>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td><span class="id-badge">${item.id}</span></td>
                        ${html}
                        <td><button class="secondary outline" onclick="deletar('${endpoint}', ${item.id})" style="padding: 2px 8px; font-size:0.8em">X</button></td>
                    </tr>
                `;
            });
        }

        // Inicia na primeira aba
        mudarAba('equipes');
    </script>
</body>
</html>
